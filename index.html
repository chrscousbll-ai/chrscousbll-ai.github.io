<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vegetation Mapper</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<style>
html, body, #map { height: 100%; margin: 0; padding: 0; }

#controls {
  position: absolute; top: 8px; left: 8px; z-index: 1000;
  background: rgba(255,255,255,0.95); padding:12px; border-radius:8px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3); font-family: system-ui;
}
#controls > div { display:flex; flex-wrap:wrap; gap:12px; align-items:center; }

button {
  padding:12px 16px;
  font-size:16px;
  border-radius:8px;
  border:1px solid #ccc;
  cursor:pointer;
  white-space:nowrap;
}

button.active {
  outline: 3px solid black;
}

#status { font-size:14px; margin-top:8px; color:#333; }
</style>
</head>
<body>
<div id="map"></div>

<div id="controls">
  <!-- Category buttons -->
  <div>
    <button class="catBtn" data-cat="light" style="background:#7bed9f;">Light</button>
    <button class="catBtn" data-cat="medium" style="background:#f6e58d;">Medium</button>
    <button class="catBtn" data-cat="heavy" style="background:#ff6b6b;">Heavy</button>
    <button class="catBtn" data-cat="dead" style="background:#a4b0be; color:white;">Dead Tree</button>
  </div>

  <!-- Functional buttons -->
  <div>
    <button id="recBtn">Start Recording</button>
    <button id="followBtn">Follow GPS</button>
    <button id="clearLast">Clear Last</button>
    <button id="clearAll">Clear All</button>
  </div>
  <div>
    <button id="exportBtn">Export GeoJSON</button>
    <label>
      <span id="importLabel">Import GeoJSON</span>
      <input type="file" id="fileInput" accept=".geojson,.json" />
    </label>
    <button id="saveLocal">Save</button>
    <button id="loadLocal">Load</button>
  </div>
  <div id="status">
    <div><strong>Live:</strong> <span id="coords">—</span></div>
    <div>Total distance: <span id="totalDist">0.00</span> m</div>
  </div>
</div>

<script>
// Categories
const CATEGORIES = {
  light: "#7bed9f",
  medium: "#f6e58d",
  heavy: "#ff6b6b",
  dead: "#a4b0be"
};

let currentCategory = "light";

// Map
const map = L.map('map');
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom:19,
  attribution:'© OpenStreetMap'
}).addTo(map);

// Try to set initial view to current location
if ("geolocation" in navigator) {
  navigator.geolocation.getCurrentPosition(pos => {
    map.setView([pos.coords.latitude, pos.coords.longitude], 16);
  }, () => {
    map.setView([44.8, -68.7], 13); // fallback if GPS fails
  });
} else {
  map.setView([44.8, -68.7], 13); // fallback if no GPS
}

let recording = false;
let followGPS = false;
let watchId = null;
let pathSegments = [];
let currentSegment = null;
let totalDistance = 0;

function haversine(a,b){
  const r=Math.PI/180,R=6371000,dLat=(b.lat-a.lat)*r,dLon=(b.lng-a.lng)*r,lat1=a.lat*r,lat2=b.lat*r;
  const aa=Math.sin(dLat/2)**2 + Math.sin(dLon/2)**2 * Math.cos(lat1) * Math.cos(lat2);
  return 2*R*Math.atan2(Math.sqrt(aa),Math.sqrt(1-aa));
}

const segmentLayers=L.layerGroup().addTo(map);

function renderSegments(){
  segmentLayers.clearLayers();
  pathSegments.forEach(seg=>
    L.polyline(seg.latlngs,{color:CATEGORIES[seg.category],weight:5}).addTo(segmentLayers)
  );
  if(currentSegment)
    L.polyline(currentSegment.latlngs,{color:CATEGORIES[currentSegment.category],weight:5,dashArray:'6 4'}).addTo(segmentLayers);
  updateStatus();
}

const recBtn=document.getElementById('recBtn');
const followBtn=document.getElementById('followBtn');
const coordsEl=document.getElementById('coords');
const totalDistEl=document.getElementById('totalDist');

// Recording toggle
recBtn.onclick = () => {
  recording = !recording;
  
  if (recording) {
    recBtn.textContent = "Stop Recording";
    recBtn.classList.add("active");
    currentSegment = { category: currentCategory, latlngs: [] };
    
    if ('geolocation' in navigator) {
      watchId = navigator.geolocation.watchPosition(onPos, console.error, { enableHighAccuracy: true });
    } else {
      alert("Geolocation not available.");
    }
  } else {
    recBtn.textContent = "Start Recording";
    recBtn.classList.remove("active");
    
    if (watchId) {
      navigator.geolocation.clearWatch(watchId);
      watchId = null;
    }
    if (currentSegment && currentSegment.latlngs.length) {
      pathSegments.push(currentSegment);
      currentSegment = null;
      renderSegments();
    }
  }
};

// Follow GPS toggle
followBtn.onclick = () => {
  followGPS = !followGPS;
  followBtn.classList.toggle("active", followGPS);
};

function onPos(p){
  const latlng={lat:p.coords.latitude,lng:p.coords.longitude};
  coordsEl.textContent=`${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`;
  
  if(recording){
    const arr=currentSegment.latlngs;
    if(arr.length>0) totalDistance+=haversine(arr[arr.length-1],latlng);
    arr.push(latlng);
    renderSegments();
  }
  
  if(followGPS) {
    map.setView([latlng.lat, latlng.lng], map.getZoom(), { animate: true });
  }
}

function updateStatus(){ totalDistEl.textContent=totalDistance.toFixed(1); }

document.getElementById('clearLast').onclick=()=>{pathSegments.pop(); renderSegments();};
document.getElementById('clearAll').onclick=()=>{pathSegments=[]; renderSegments(); totalDistance=0;};

document.getElementById('exportBtn').onclick=()=>{
  const data={type:"FeatureCollection",features:pathSegments.map(seg=>({type:"Feature",properties:{category:seg.category},geometry:{type:"LineString",coordinates:seg.latlngs.map(pt=>[pt.lng,pt.lat])}}))};
  const blob=new Blob([JSON.stringify(data)],{type:"application/json"});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download="vegmap.geojson"; a.click(); URL.revokeObjectURL(url);
};

document.getElementById('fileInput').onchange=e=>{
  const file=e.target.files[0]; if(!file) return;
  const reader=new FileReader(); reader.onload=ev=>{
    const geo=JSON.parse(ev.target.result);
    geo.features.forEach(f=>{
      if(f.geometry.type==="LineString"){
        const coords=f.geometry.coordinates.map(c=>({lat:c[1],lng:c[0]}));
        pathSegments.push({category:f.properties.category||"light",latlngs:coords});
      }
    });
    renderSegments();
  }; reader.readAsText(file);
};

document.getElementById('saveLocal').onclick=()=>{localStorage.setItem('vegmap',JSON.stringify(pathSegments));};
document.getElementById('loadLocal').onclick=()=>{const data=localStorage.getItem('vegmap'); if(data){pathSegments=JSON.parse(data); renderSegments();}};

// Category button logic
document.querySelectorAll('.catBtn').forEach(btn=>{
  btn.onclick=()=>{
    currentCategory=btn.dataset.cat;
    document.querySelectorAll('.catBtn').forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
  };
});

// Set Light as default selected
document.querySelector('.catBtn[data-cat="light"]').classList.add("active");
</script>
</body>
</html>
