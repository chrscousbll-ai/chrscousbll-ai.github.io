<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Vegetation Mapping â€“ Final KML with Location Indicator & Tree Icon</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<style>
  html, body { margin:0; padding:0; height:100%; }
  #map { height:100%; width:100%; }
  .control-bar {
    position: absolute; top:10px; left:10px;
    display:flex; flex-direction:column; gap:6px;
    z-index:1000;
  }
  .btn {
    background:#fff; border:1px solid #555; padding:6px 10px;
    border-radius:6px; font-size:14px; cursor:pointer;
  }
  .btn.active { background:#0078ff; color:#fff; }
</style>
</head>
<body>
<div id="map"></div>

<div class="control-bar">
  <button class="btn veg" data-color="green">Light Veg</button>
  <button class="btn veg" data-color="orange">Medium Veg</button>
  <button class="btn veg" data-color="red">Heavy Veg</button>
  <button class="btn" id="deadTree">Dead Tree</button>
  <button class="btn" id="startStop">Start Recording</button>
  <button class="btn" id="followGps">Follow GPS</button>
  <button class="btn" id="saveKML">Save KML</button>
  <button class="btn" id="clearLast">Clear Last Line</button>
  <button class="btn" id="clearAll">Clear All</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/togeojson@0.16.0/dist/togeojson.umd.js"></script>

<script>
const map = L.map('map').fitWorld();
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom:19, attribution:'&copy; OpenStreetMap contributors'
}).addTo(map);

// Start GPS tracking (but do not auto-pan unless follow is true)
map.locate({setView:true, watch:true, enableHighAccuracy:true});

let recording = false;
let follow = false;
let currentColor = null;
let polyline = null;
let polylines = [];
let markers = [];
let userMarker = null;   // persistent location marker

function startNewLine(color) {
  polyline = L.polyline([], {color: color, weight:4}).addTo(map);
  polylines.push(polyline);
}

function toggleRecording() {
  recording = !recording;
  document.getElementById('startStop').textContent =
    recording ? 'Stop Recording' : 'Start Recording';
  if (recording && currentColor) startNewLine(currentColor);
}

function updatePosition(e) {
  const latlng = e.latlng;

  // Always show/update the blue-dot location marker
  if (!userMarker) {
    userMarker = L.circleMarker(latlng, {
      radius: 7,
      color: '#3388ff',
      fillColor: '#3388ff',
      fillOpacity: 0.8
    }).addTo(map);
  } else {
    userMarker.setLatLng(latlng);
  }

  // Add to polyline if recording
  if (recording && polyline) polyline.addLatLng(latlng);

  // Pan only if follow mode is on
  if (follow) map.panTo(latlng);
}
map.on('locationfound', updatePosition);

document.querySelectorAll('.veg').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.veg').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    currentColor = btn.dataset.color;
    if (recording) startNewLine(currentColor);
  });
});

document.getElementById('startStop').onclick = toggleRecording;

document.getElementById('followGps').onclick = () => {
  follow = !follow;
  document.getElementById('followGps').classList.toggle('active', follow);
};

document.getElementById('deadTree').onclick = () => {
  if (!map.getCenter()) return;
  const center = map.getCenter();
  // Stable evergreen tree icon
  const icon = L.icon({
    iconUrl: 'https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers/img/marker-icon-green.png',
    iconSize: [25, 41],
    iconAnchor: [12, 41],
    popupAnchor: [1, -34]
  });
  const marker = L.marker(center,{icon:icon}).addTo(map);
  markers.push(marker);
};

document.getElementById('clearLast').onclick = () => {
  const last = polylines.pop();
  if (last) map.removeLayer(last);
};

document.getElementById('clearAll').onclick = () => {
  polylines.forEach(l=>map.removeLayer(l));
  markers.forEach(m=>map.removeLayer(m));
  if (userMarker) userMarker.remove();
  polylines=[]; markers=[]; userMarker=null;
};

function saveKML(){
  let kml = `<?xml version="1.0" encoding="UTF-8"?>\n<kml xmlns="http://www.opengis.net/kml/2.2">\n<Document>\n`;
  polylines.forEach((line,i)=>{
    const coords = line.getLatLngs().map(ll=>`${ll.lng},${ll.lat},0`).join(' ');
    kml += `<Placemark><name>Path ${i+1}</name><Style><LineStyle><color>${colorToKML(line.options.color)}</color><width>4</width></LineStyle></Style><LineString><coordinates>${coords}</coordinates></LineString></Placemark>\n`;
  });
  markers.forEach((m,i)=>{
    const ll = m.getLatLng();
    kml += `<Placemark><name>Dead Tree ${i+1}</name><Point><coordinates>${ll.lng},${ll.lat},0</coordinates></Point></Placemark>\n`;
  });
  kml += `</Document></kml>`;
  const blob = new Blob([kml],{type:'application/vnd.google-earth.kml+xml'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'vegetation.kml';
  a.click();
  URL.revokeObjectURL(url);
}

function colorToKML(c){
  const ctx = document.createElement('canvas').getContext('2d');
  ctx.fillStyle = c;
  const rgb = ctx.fillStyle.match(/\d+/g).map(Number);
  return `ff${toHex(rgb[2])}${toHex(rgb[1])}${toHex(rgb[0])}`;
}
function toHex(n){ return n.toString(16).padStart(2,'0'); }

document.getElementById('saveKML').onclick = saveKML;
</script>
</body>
</html>
