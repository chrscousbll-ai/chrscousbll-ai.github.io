<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vegetation Mapping Tool</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body { font-family: Arial, sans-serif; margin: 10px; }
        #map { height: 600px; width: 100%; margin-top: 10px; }
        button { margin: 2px; padding: 5px 10px; cursor: pointer; }
        .selected { border: 2px solid black; background-color: #ddd; }
        #distances { margin-top: 10px; }
        #distances ul { list-style: none; padding-left: 0; }
        #distances li { margin-bottom: 5px; }
    </style>
</head>
<body>
    <h1>Vegetation Mapping Tool</h1>

    <div>
        <button id="btn-no" onclick="selectVegetation('no', this)">No Vegetation</button>
        <button id="btn-light" onclick="selectVegetation('light', this)">Light</button>
        <button id="btn-moderate" onclick="selectVegetation('moderate', this)">Moderate</button>
        <button id="btn-heavy" onclick="selectVegetation('heavy', this)">Heavy</button>
    </div>

    <div id="map"></div>

    <div id="distances">
        <h3>Distance Traveled (meters)</h3>
        <ul>
            <li>No Vegetation: <span id="dist-no">0</span></li>
            <li>Light: <span id="dist-light">0</span></li>
            <li>Moderate: <span id="dist-moderate">0</span></li>
            <li>Heavy: <span id="dist-heavy">0</span></li>
        </ul>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // Initialize map
        const map = L.map('map').setView([45.0, -68.7], 10);

        // OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);

        // Vegetation settings
        let currentVegetation = 'no';
        let lastSelectedButton = document.getElementById("btn-no");

        const vegetationColors = {
            "no": "gray",
            "light": "green",
            "moderate": "orange",
            "heavy": "red"
        };

        // Track last point per vegetation type
        const lastPoint = {
            "no": null,
            "light": null,
            "moderate": null,
            "heavy": null
        };

        // Track total distance per type
        const totalDistance = {
            "no": 0,
            "light": 0,
            "moderate": 0,
            "heavy": 0
        };

        function selectVegetation(type, button) {
            currentVegetation = type;

            if (lastSelectedButton) lastSelectedButton.classList.remove("selected");

            button.classList.add("selected");
            lastSelectedButton = button;

            console.log("Selected vegetation:", type);
        }

        function drawVegetation(lat, lng) {
            const color = vegetationColors[currentVegetation] || "black";

            // Draw the circle
            L.circle([lat, lng], { radius: 5, color: color, fillColor: color, fillOpacity: 0.7 }).addTo(map);

            // Calculate distance from last point of the same type
            const prev = lastPoint[currentVegetation];
            if (prev) {
                const dist = map.distance([lat, lng], prev); // meters
                totalDistance[currentVegetation] += dist;
                document.getElementById("dist-" + currentVegetation).innerText = totalDistance[currentVegetation].toFixed(1);
            }

            lastPoint[currentVegetation] = [lat, lng];

            // Switch back to "No Vegetation"
            selectVegetation('no', document.getElementById("btn-no"));
        }

        // Map click handler
        map.on('click', function(e) {
            drawVegetation(e.latlng.lat, e.latlng.lng);
        });

        // Highlight default button
        lastSelectedButton.classList.add("selected");

        // --- GPS Follow ---
        function startGPSFollow() {
            if (!navigator.geolocation) {
                alert("Geolocation is not supported by your browser");
                return;
            }

            navigator.geolocation.watchPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;

                    // Move the map to follow your position
                    map.setView([lat, lng], map.getZoom());

                    // Show your location on the map
                    if (!window.userMarker) {
                        window.userMarker = L.circle([lat, lng], { radius: 5, color: "blue", fillColor: "blue", fillOpacity: 0.7 }).addTo(map);
                    } else {
                        window.userMarker.setLatLng([lat, lng]);
                    }
                },
                (error) => {
                    console.error("Geolocation error:", error);
                },
                { enableHighAccuracy: true, maximumAge: 1000 }
            );
        }

        // Start GPS follow
        startGPSFollow();
    </script>
</body>
</html>
