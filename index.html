<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Vegetation Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  body, html { margin:0; padding:0; height:100%; }
  #map { height:100%; }
  .control-buttons { position:absolute; top:10px; left:10px; z-index:1000; }
  .control-buttons button { display:block; margin-bottom:10px; padding:10px 15px; font-size:16px; }
  .legend { position:absolute; bottom:10px; left:10px; z-index:1000; background:white; padding:5px; border-radius:5px; }
  .legend div { margin-bottom:3px; }
</style>
</head>
<body>
<div id="map"></div>
<div class="control-buttons">
  <button id="followBtn">Follow GPS</button>
  <button id="startBtn">Start Recording</button>
  <button id="stopBtn">Stop Recording</button>
  <button id="clearLastBtn">Clear Last Line</button>
  <button id="clearAllBtn">Clear All Lines</button>
  <button id="saveBtn">Save (KML)</button>
  <hr>
  <button class="vegBtn" data-type="Light">Light</button>
  <button class="vegBtn" data-type="Medium">Medium</button>
  <button class="vegBtn" data-type="Heavy">Heavy</button>
  <button class="vegBtn" data-type="Dead Tree">Dead Tree</button>
  <button class="vegBtn" data-type="No Vegetation">No Vegetation</button>
</div>
<div class="legend" id="legend"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let map = L.map('map').setView([45.0, -69.0], 13);

// Base layer
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

// Vegetation types and colors
const vegetationTypes = {
  "Light": "green",
  "Medium": "orange",
  "Heavy": "red",
  "Dead Tree": "brown",
  "No Vegetation": "gray"
};

// Legend
let legend = document.getElementById('legend');
for (let type in vegetationTypes) {
  let div = document.createElement('div');
  div.innerHTML = `<span style="display:inline-block;width:12px;height:12px;background:${vegetationTypes[type]};margin-right:5px;"></span>${type}`;
  legend.appendChild(div);
}

// State
let isRecording = false;
let followGPS = false;
let currentVegetation = "Light";
let activeVegBtn = null;
let points = [];
let lines = [];
let markerLayer = L.layerGroup().addTo(map);
let gpsMarker = null;
let currentLine = null;

// Center map on GPS when loaded
if (navigator.geolocation) {
  navigator.geolocation.getCurrentPosition(pos => {
    const latlng = [pos.coords.latitude, pos.coords.longitude];
    map.setView(latlng, 16);
  }, err => console.warn("GPS error:", err), {enableHighAccuracy:true});
}

// Follow GPS button
document.getElementById('followBtn').onclick = () => {
  followGPS = !followGPS;
  document.getElementById('followBtn').innerText = followGPS ? "Following GPS" : "Follow GPS";
};

// Start/Stop Recording
document.getElementById('startBtn').onclick = () => { 
  isRecording = true; 
  currentLine = null; 
};
document.getElementById('stopBtn').onclick = () => { 
  isRecording = false; 
  currentLine = null; 
};

// Clear lines
document.getElementById('clearLastBtn').onclick = () => {
  if (lines.length) map.removeLayer(lines.pop());
};
document.getElementById('clearAllBtn').onclick = () => {
  lines.forEach(l => map.removeLayer(l));
  lines = [];
};

// Save as KML for Google Maps
document.getElementById('saveBtn').onclick = () => {
  let kml = `<?xml version="1.0" encoding="UTF-8"?>
  <kml xmlns="http://www.opengis.net/kml/2.2">
    <Document>
      <name>Vegetation Map</name>`;

  // Add Dead Tree points
  points.forEach(p => {
    if (p.type === "Dead Tree") {
      kml += `
      <Placemark>
        <name>${p.type}</name>
        <Point>
          <coordinates>${p.lng},${p.lat},0</coordinates>
        </Point>
      </Placemark>`;
    }
  });

  // Add lines for other vegetation types
  lines.forEach((line, index) => {
    const latlngs = line.getLatLngs();
    let coords = latlngs.map(ll => `${ll.lng},${ll.lat},0`).join(' ');
    kml += `
    <Placemark>
      <name>Path ${index + 1} (${currentVegetation})</name>
      <LineString>
        <coordinates>${coords}</coordinates>
      </LineString>
    </Placemark>`;
  });

  kml += `
    </Document>
  </kml>`;

  const dataStr = "data:text/xml;charset=utf-8," + encodeURIComponent(kml);
  const dlAnchor = document.createElement('a');
  dlAnchor.setAttribute("href", dataStr);
  dlAnchor.setAttribute("download", "vegetation_map.kml");
  dlAnchor.click();
};

// Vegetation buttons
document.querySelectorAll('.vegBtn').forEach(btn => {
  btn.addEventListener('click', () => {
    const type = btn.dataset.type;

    // Dead Tree: one-time action at GPS location
    if (type === "Dead Tree") {
      if (gpsMarker) {
        const latlng = gpsMarker.getLatLng();
        let marker = L.circleMarker(latlng, {
          color: vegetationTypes["Dead Tree"],
          radius: 6
        }).addTo(markerLayer);
        marker.bindPopup("Dead Tree");
        points.push({lat: latlng.lat, lng: latlng.lng, type: "Dead Tree"});
        marker.on('click', () => {
          markerLayer.removeLayer(marker);
          points = points.filter(p => p.lat !== latlng.lat || p.lng !== latlng.lng);
        });
      }
      return; // Do not highlight Dead Tree or set currentVegetation
    }

    // For other vegetation types: set currentVegetation and highlight
    currentVegetation = type;
    if (activeVegBtn) activeVegBtn.style.backgroundColor = '';
    btn.style.backgroundColor = '#ddd';
    activeVegBtn = btn;
  });
});

// GPS tracking with live marker and path recording
if (navigator.geolocation) {
  navigator.geolocation.watchPosition(pos => {
    const latlng = [pos.coords.latitude, pos.coords.longitude];

    // Update GPS marker
    if (!gpsMarker) gpsMarker = L.marker(latlng, {title:"You"}).addTo(map);
    else gpsMarker.setLatLng(latlng);

    if (followGPS) map.setView(latlng);

    // Record path for non-Dead Tree types
    if (isRecording && currentVegetation !== "Dead Tree") {
      if (!currentLine) {
        currentLine = L.polyline([latlng], {color: vegetationTypes[currentVegetation]}).addTo(map);
        lines.push(currentLine);
      } else {
        currentLine.addLatLng(latlng);
      }
      points.push({lat: latlng[0], lng: latlng[1], type: currentVegetation});
    }

  }, err => console.warn("GPS error:", err), {enableHighAccuracy:true});
}
</script>
</body>
</html>
