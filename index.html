<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vegetation Mapper</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<style>
html, body, #map { height: 100%; margin: 0; padding: 0; }

#controls {
  position: absolute; top: 8px; left: 8px; z-index: 1000;
  background: rgba(255,255,255,0.95); padding:12px; border-radius:8px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3); font-family: system-ui;
}
#controls > div { display:flex; flex-wrap:wrap; gap:12px; align-items:center; }
#controls label { font-size:16px; display:flex; align-items:center; gap:6px; }

button {
  padding:12px 16px;
  font-size:16px;
  border-radius:8px;
  border:1px solid #ccc;
  cursor:pointer;
  white-space:nowrap;
}

#status { font-size:14px; margin-top:8px; color:#333; }
</style>
</head>
<body>
<div id="map"></div>

<div id="controls">
  <div>
    <button id="startRec">Start Recording</button>
    <button id="stopRec" disabled>Stop</button>
    <label><input type="checkbox" id="followToggle"> Follow GPS</label>
    <button id="clearLast">Clear Last</button>
    <button id="clearAll">Clear All</button>
  </div>
  <div>
    <button id="exportBtn">Export GeoJSON</button>
    <label>
      <span id="importLabel">Import GeoJSON</span>
      <input type="file" id="fileInput" accept=".geojson,.json" />
    </label>
    <button id="saveLocal">Save (localStorage)</button>
    <button id="loadLocal">Load (localStorage)</button>
  </div>
  <div id="status">
    <div><strong>Live:</strong> <span id="coords">—</span></div>
    <div>Total distance: <span id="totalDist">0.00</span> m</div>
  </div>
</div>

<script>
// Map
const map = L.map('map').setView([44.8, -68.7], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19, attribution:'© OpenStreetMap'}).addTo(map);

let recording=false, watchId=null, pathSegments=[], currentSegment=null;
let totalDistance=0;

function haversine(a,b){
  const r=Math.PI/180,R=6371000,dLat=(b.lat-a.lat)*r,dLon=(b.lng-a.lng)*r,lat1=a.lat*r,lat2=b.lat*r;
  const aa=Math.sin(dLat/2)**2 + Math.sin(dLon/2)**2 * Math.cos(lat1) * Math.cos(lat2);
  return 2*R*Math.atan2(Math.sqrt(aa),Math.sqrt(1-aa));
}

const segmentLayers=L.layerGroup().addTo(map);

function renderSegments(){
  segmentLayers.clearLayers();
  pathSegments.forEach(seg=>L.polyline(seg.latlngs,{color:'#000',weight:5}).addTo(segmentLayers));
  if(currentSegment) L.polyline(currentSegment.latlngs,{color:'#000',weight:5,dashArray:'6 4'}).addTo(segmentLayers);
  updateStatus();
}

const startRecBtn=document.getElementById('startRec');
const stopRecBtn=document.getElementById('stopRec');
const followToggle=document.getElementById('followToggle');
const coordsEl=document.getElementById('coords');
const totalDistEl=document.getElementById('totalDist');

startRecBtn.onclick=()=>{
  if(recording) return;
  recording=true; startRecBtn.disabled=true; stopRecBtn.disabled=false;
  currentSegment={latlngs:[]};
  if('geolocation' in navigator) watchId=navigator.geolocation.watchPosition(onPos,console.error,{enableHighAccuracy:true});
  else alert('Geolocation not available.');
};

stopRecBtn.onclick=()=>{
  recording=false; startRecBtn.disabled=false; stopRecBtn.disabled=true;
  if(watchId){navigator.geolocation.clearWatch(watchId); watchId=null;}
  if(currentSegment && currentSegment.latlngs.length){pathSegments.push(currentSegment); currentSegment=null; renderSegments();}
};

function onPos(p){
  const latlng={lat:p.coords.latitude,lng:p.coords.longitude};
  coordsEl.textContent=`${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`;
  if(recording){
    const arr=currentSegment.latlngs;
    if(arr.length>0) totalDistance+=haversine(arr[arr.length-1],latlng);
    arr.push(latlng); renderSegments();
  }
  if(followToggle.checked) map.setView([latlng.lat,latlng.lng],map.getZoom(),{animate:true});
}

function updateStatus(){ totalDistEl.textContent=totalDistance.toFixed(1); }

document.getElementById('clearLast').onclick=()=>{pathSegments.pop(); renderSegments();};
document.getElementById('clearAll').onclick=()=>{pathSegments=[]; renderSegments(); totalDistance=0;};

document.getElementById('exportBtn').onclick=()=>{
  const data={type:"FeatureCollection",features:pathSegments.map(seg=>({type:"Feature",geometry:{type:"LineString",coordinates:seg.latlngs.map(pt=>[pt.lng,pt.lat])}}))};
  const blob=new Blob([JSON.stringify(data)],{type:"application/json"});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download="vegmap.geojson"; a.click(); URL.revokeObjectURL(url);
};

document.getElementById('fileInput').onchange=e=>{
  const file=e.target.files[0]; if(!file) return;
  const reader=new FileReader(); reader.onload=ev=>{
    const geo=JSON.parse(ev.target.result);
    geo.features.forEach(f=>{
      if(f.geometry.type==="LineString"){
        const coords=f.geometry.coordinates.map(c=>({lat:c[1],lng:c[0]}));
        pathSegments.push({latlngs:coords});
      }
    });
    renderSegments();
  }; reader.readAsText(file);
};

document.getElementById('saveLocal').onclick=()=>{localStorage.setItem('vegmap',JSON.stringify(pathSegments));};
document.getElementById('loadLocal').onclick=()=>{const data=localStorage.getItem('vegmap'); if(data){pathSegments=JSON.parse(data); renderSegments();}}
</script>
</body>
</html>
