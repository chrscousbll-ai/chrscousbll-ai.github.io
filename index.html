<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vegetation Mapping â€“ Continuous Paths</title>

<link rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  html, body, #map { height: 100%; margin: 0; }
  .control-buttons {
    position: absolute;
    top: 10px;
    left: 10px;
    z-index: 1000;
    background: rgba(255,255,255,0.9);
    padding: 6px;
    border-radius: 8px;
    font-family: sans-serif;
  }
  .control-buttons button {
    display: block;
    margin: 4px 0;
    width: 160px;
    padding: 6px;
  }
  .active-btn {
    background: #4caf50;
    color: #fff;
  }
</style>
</head>
<body>

<div id="map"></div>

<div class="control-buttons">
  <button id="startBtn">Start Recording</button>
  <button id="stopBtn">Stop Recording</button>

  <button id="lightBtn">Light Vegetation</button>
  <button id="moderateBtn">Moderate Vegetation</button>
  <button id="heavyBtn">Heavy Vegetation</button>
  <button id="noneBtn">No Vegetation</button>

  <button id="deadTreeBtn">Dead Tree Marker</button>
  <button id="saveBtn">Save KML</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const map = L.map('map').setView([44.8, -68.9], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19
}).addTo(map);

let recording = false;
let segments = [];   // each: {color, coords[], poly}
let currentSegment = null;
let deadTrees = [];
let lastPosition = null;
let gpsMarker = null;
let currentColor = 'green';

/* -------- Vegetation color selection -------- */
function setVegColor(color, id) {
  currentColor = color;
  document.querySelectorAll('.veg-btn').forEach(b => b.classList.remove('active-btn'));
  document.getElementById(id).classList.add('active-btn');

  // if currently recording, start a new segment for the new color
  if (recording) startNewSegment();
}

['light','moderate','heavy','none'].forEach(type => {
  const id = type + 'Btn';
  const color = {light:'green', moderate:'orange', heavy:'red', none:'gray'}[type];
  const btn = document.getElementById(id);
  btn.classList.add('veg-btn');
  btn.addEventListener('click', () => setVegColor(color, id));
});

/* -------- Recording controls -------- */
function startNewSegment() {
  currentSegment = {
    color: currentColor,
    coords: [],
    poly: L.polyline([], { color: currentColor }).addTo(map)
  };
  segments.push(currentSegment);
}

function startRecording() {
  if (!recording) {
    recording = true;
    startNewSegment();
  }
}
function stopRecording() { recording = false; }

document.getElementById('startBtn').addEventListener('click', startRecording);
document.getElementById('stopBtn').addEventListener('click', stopRecording);

/* -------- Dead tree markers -------- */
function addDeadTree() {
  if (!lastPosition) { alert("No GPS fix yet."); return; }
  L.marker(lastPosition, { title: "Dead Tree" }).addTo(map);
  deadTrees.push(lastPosition);
}
document.getElementById('deadTreeBtn').addEventListener('click', addDeadTree);

/* -------- GPS watch -------- */
navigator.geolocation.watchPosition(
  pos => {
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;
    const newPos = [lat, lng];

    if (lastPosition) {
      const dist = map.distance(lastPosition, newPos);
      if (dist > 50) return;
    }
    lastPosition = newPos;

    if (!gpsMarker) {
      gpsMarker = L.circleMarker(newPos, {
        radius: 6, color: 'blue', fillColor: '#00f', fillOpacity: 0.7
      }).addTo(map);
    } else {
      gpsMarker.setLatLng(newPos);
    }

    if (recording && currentSegment) {
      currentSegment.coords.push(newPos);
      currentSegment.poly.addLatLng(newPos);
    }
  },
  err => console.error("GPS error:", err),
  { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 }
);

/* -------- KML Export -------- */
function coordsToKml(coords) {
  return coords.map(pt => `${pt[1]},${pt[0]},0`).join(' ');
}
function colorToKml(c) {
  const colors = {
    green: 'ff00ff00',
    orange: 'ff00a5ff',
    red:   'ff0000ff',
    gray:  'ff888888'
  };
  return colors[c] || 'ff00ff00';
}
function generateKML() {
  let kml = `<?xml version="1.0" encoding="UTF-8"?>\n<kml xmlns="http://www.opengis.net/kml/2.2">\n<Document>\n`;

  segments.forEach((seg, i) => {
    if (seg.coords.length > 1) {
      kml += `<Placemark><name>Path ${i+1}</name>\n`;
      kml += `<Style><LineStyle><color>${colorToKml(seg.color)}</color><width>4</width></LineStyle></Style>\n`;
      kml += `<LineString><coordinates>${coordsToKml(seg.coords)}</coordinates></LineString>\n</Placemark>\n`;
    }
  });

  deadTrees.forEach((pt, i) => {
    kml += `<Placemark><name>Dead Tree ${i+1}</name>\n<Point><coordinates>${pt[1]},${pt[0]},0</coordinates></Point>\n</Placemark>\n`;
  });

  kml += `</Document>\n</kml>`;
  return kml;
}
function saveKML() {
  const kml = generateKML();
  if (!kml.trim()) { alert("No data to save!"); return; }
  const blob = new Blob([kml], { type: 'application/vnd.google-earth.kml+xml' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'vegetation-map.kml';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
document.getElementById('saveBtn').addEventListener('click', saveKML);
</script>
</body>
</html>
