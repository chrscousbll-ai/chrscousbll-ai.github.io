<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vegetation Mapping â€“ KML Save Fix</title>

<!-- Leaflet CSS -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<style>
  html, body, #map { height: 100%; margin: 0; }
  .control-buttons {
    position: absolute;
    top: 10px;
    left: 10px;
    z-index: 1000;
    background: rgba(255,255,255,0.9);
    padding: 6px;
    border-radius: 8px;
    font-family: sans-serif;
  }
  .control-buttons button {
    display: block;
    margin: 4px 0;
    width: 140px;
    padding: 6px;
  }
</style>
</head>
<body>

<div id="map"></div>
<div class="control-buttons">
  <button id="startBtn">Start Recording</button>
  <button id="stopBtn">Stop Recording</button>
  <button id="deadTreeBtn">Dead Tree Marker</button>
  <button id="saveBtn">Save KML</button>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* -------------------- Map Setup -------------------- */
const map = L.map('map', { center: [44.8, -68.9], zoom: 13 });
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
}).addTo(map);

let recording = false;
let currentLine = [];
let lines = [];
let deadTrees = [];

/* -------------------- Recording Logic -------------------- */
function startRecording() {
  if (!recording) {
    currentLine = [];
    lines.push(currentLine);
    recording = true;
  }
}
function stopRecording() {
  recording = false;
}

/* simulate GPS updates every 3s for demo */
setInterval(() => {
  if (recording) {
    const c = map.getCenter();
    const offset = (Math.random() - 0.5) * 0.001;
    const latlng = [c.lat + offset, c.lng + offset];
    currentLine.push(latlng);
    L.polyline([latlng], { color: 'green' }).addTo(map);
  }
}, 3000);

/* -------------------- Dead Tree Marker -------------------- */
function addDeadTree() {
  const c = map.getCenter();
  L.marker(c, { title: "Dead Tree" }).addTo(map);
  deadTrees.push(c);
}

/* -------------------- KML Export -------------------- */
function generateKML() {
  function coordsToKml(coords) {
    return coords.map(pt => `${pt[1]},${pt[0]},0`).join(' ');
  }

  let kml = `<?xml version="1.0" encoding="UTF-8"?>\n`;
  kml += `<kml xmlns="http://www.opengis.net/kml/2.2">\n<Document>\n`;

  // Lines
  lines.forEach((line, idx) => {
    if (line.length > 1) {
      kml += `<Placemark><name>Path ${idx+1}</name>\n`;
      kml += `<LineString><coordinates>${coordsToKml(line)}</coordinates></LineString>\n`;
      kml += `</Placemark>\n`;
    }
  });

  // Dead Trees
  deadTrees.forEach((pt, idx) => {
    kml += `<Placemark><name>Dead Tree ${idx+1}</name>\n`;
    kml += `<Point><coordinates>${pt[1]},${pt[0]},0</coordinates></Point>\n`;
    kml += `</Placemark>\n`;
  });

  kml += `</Document>\n</kml>`;
  return kml;
}

function saveKML() {
  const kmlString = generateKML();
  console.log("Generated KML:", kmlString); // debugging

  if (!kmlString || kmlString.trim() === '') {
    alert("No data to save!");
    return;
  }

  const blob = new Blob([kmlString], { type: 'application/vnd.google-earth.kml+xml' });
  const url  = URL.createObjectURL(blob);

  const link = document.createElement('a');
  link.href = url;
  link.download = 'vegetation-map.kml';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}

/* -------------------- Button Hooks -------------------- */
document.getElementById('startBtn').addEventListener('click', startRecording);
document.getElementById('stopBtn').addEventListener('click', stopRecording);
document.getElementById('deadTreeBtn').addEventListener('click', addDeadTree);
document.getElementById('saveBtn').addEventListener('click', saveKML);
</script>
</body>
</html>
