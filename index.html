<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Vegetation Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  body, html { margin:0; padding:0; height:100%; }
  #map { height:100%; }
  .control-buttons { position:absolute; top:10px; left:10px; z-index:1000; }
  .control-buttons button { display:block; margin-bottom:10px; padding:10px 15px; font-size:16px; }
  .legend { position:absolute; bottom:10px; left:10px; z-index:1000; background:white; padding:5px; border-radius:5px; }
  .legend div { margin-bottom:3px; }
</style>
</head>
<body>
<div id="map"></div>
<div class="control-buttons">
  <button id="followBtn">Follow GPS</button>
  <button id="startBtn">Start Recording</button>
  <button id="stopBtn">Stop Recording</button>
  <button id="clearLastBtn">Clear Last Line</button>
  <button id="clearAllBtn">Clear All Lines</button>
  <button id="saveBtn">Save</button>
  <hr>
  <button class="vegBtn" data-type="Light">Light</button>
  <button class="vegBtn" data-type="Medium">Medium</button>
  <button class="vegBtn" data-type="Heavy">Heavy</button>
  <button class="vegBtn" data-type="Dead Tree">Dead Tree</button>
  <button class="vegBtn" data-type="No Vegetation">No Vegetation</button>
</div>
<div class="legend" id="legend"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let map = L.map('map').setView([45.0, -69.0], 13);

// Base layer
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19
}).addTo(map);

// Vegetation types
const vegetationTypes = {
  "Light": "green",
  "Medium": "orange",
  "Heavy": "red",
  "Dead Tree": "brown",
  "No Vegetation": "gray"
};

// Legend
let legend = document.getElementById('legend');
for (let type in vegetationTypes) {
  let div = document.createElement('div');
  div.innerHTML = `<span style="display:inline-block;width:12px;height:12px;background:${vegetationTypes[type]};margin-right:5px;"></span>${type}`;
  legend.appendChild(div);
}

// State
let isRecording = false;
let followGPS = false;
let currentVegetation = "Light";
let points = [];
let lines = [];
let markerLayer = L.layerGroup().addTo(map);

// Follow GPS
document.getElementById('followBtn').onclick = () => {
  followGPS = !followGPS;
  document.getElementById('followBtn').innerText = followGPS ? "Following GPS" : "Follow GPS";
};

// Recording
document.getElementById('startBtn').onclick = () => { isRecording = true; };
document.getElementById('stopBtn').onclick = () => { isRecording = false; };

// Clear
document.getElementById('clearLastBtn').onclick = () => {
  if (lines.length) {
    map.removeLayer(lines.pop());
  }
};
document.getElementById('clearAllBtn').onclick = () => {
  lines.forEach(l => map.removeLayer(l));
  lines = [];
};

// Save
document.getElementById('saveBtn').onclick = () => {
  let geojson = markerLayer.toGeoJSON();
  let dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(geojson));
  let dlAnchor = document.createElement('a');
  dlAnchor.setAttribute("href", dataStr);
  dlAnchor.setAttribute("download", "vegetation_map.geojson");
  dlAnchor.click();
};

// Vegetation type buttons
document.querySelectorAll('.vegBtn').forEach(btn => {
  btn.addEventListener('click', () => {
    currentVegetation = btn.dataset.type;
  });
});

// Map click for adding vegetation points
map.on('click', e => {
  const lat = e.latlng.lat;
  const lng = e.latlng.lng;

  let marker = L.circleMarker([lat, lng], {
    color: vegetationTypes[currentVegetation],
    radius: 6
  }).addTo(markerLayer);
  marker.bindPopup(currentVegetation);

  // Save point
  points.push({lat, lng, type: currentVegetation});

  // Draw line if recording and previous point same type (skip No Vegetation)
  if (isRecording && points.length > 1 && currentVegetation !== "No Vegetation") {
    const lastPoint = points[points.length-2];
    if (lastPoint.type === currentVegetation) {
      let line = L.polyline([[lastPoint.lat, lastPoint.lng], [lat, lng]], {
        color: vegetationTypes[currentVegetation]
      }).addTo(map);
      lines.push(line);
    }
  }

  // Dead Tree deletion only on marker click
  if (currentVegetation === "Dead Tree") {
    marker.on('click', () => {
      markerLayer.removeLayer(marker);
      points = points.filter(p => p.lat !== lat || p.lng !== lng);
    });
  }
});

// GPS tracking with live marker
let gpsMarker = null;
if (navigator.geolocation) {
  navigator.geolocation.watchPosition(pos => {
    const latlng = [pos.coords.latitude, pos.coords.longitude];

    if (!gpsMarker) {
      gpsMarker = L.marker(latlng, {title: "You"}).addTo(map);
    } else {
      gpsMarker.setLatLng(latlng);
    }

    if (followGPS) {
      map.setView(latlng);
    }
  }, err => {
    console.warn("GPS error:", err);
  }, {enableHighAccuracy:true});
}
</script>
</body>
</html>
